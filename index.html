<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Météo locale</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(to bottom, #5dade2, #aed6f1);
      color: #fff;
      text-align: center;
      padding: 20px;
      transition: background 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    #weather-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      opacity: 0.3;
    }
    .weather-icon {
      position: absolute;
      width: 60px;
      height: 60px;
      animation: fall 10s linear infinite;
    }
    @keyframes fall {
      from { transform: translateY(-100px); }
      to { transform: translateY(100vh); }
    }
  </style>
</head>
<body>
  <div id="weather-animation"></div>
  <!-- Le reste du contenu HTML reste inchangé -->
  <!-- ... -->
  <script>
    function setWeatherAnimation(condition) {
      const container = document.getElementById("weather-animation");
      container.innerHTML = "";
      let icon = "";

      if (condition.includes("rain")) {
        icon = "☔"; // parapluie
      } else if (condition.includes("snow")) {
        icon = "❄"; // flocon
      } else if (condition.includes("cloud")) {
        icon = "☁"; // nuage
      } else if (condition.includes("sun") || condition.includes("clear")) {
        icon = "☀"; // soleil
      } else if (condition.includes("storm") || condition.includes("thunder")) {
        icon = "⛈"; // orage
      }

      for (let i = 0; i < 20; i++) {
        const elem = document.createElement("div");
        elem.className = "weather-icon";
        elem.style.left = Math.random() * 100 + "%";
        elem.style.top = Math.random() * 20 + "px";
        elem.style.fontSize = Math.random() * 24 + 24 + "px";
        elem.textContent = icon;
        container.appendChild(elem);
      }
    }

    function cacheData(key, data) {
      const payload = {
        data,
        timestamp: Date.now()
      };
      localStorage.setItem(key, JSON.stringify(payload));
    }

    function getCachedData(key, maxAgeMs) {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (Date.now() - parsed.timestamp > maxAgeMs) return null;
      return parsed.data;
    }

    async function fetchWeather() {
      const cacheKey = `weather-${city}-${source}`;
      const cached = getCachedData(cacheKey, 6 * 60 * 60 * 1000); // 6h
      if (cached) {
        applyWeatherData(cached);
        return;
      }

      let data;
      if (source === "weatherapi") {
        const res = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${weatherApiKey}&q=${city}&days=3&lang=fr&aqi=no&alerts=no`);
        data = await res.json();
        cacheData(cacheKey, { type: "weatherapi", data });
        applyWeatherData({ type: "weatherapi", data });
        return;
      }

      if (source === "openweathermap") {
        const currentRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&lang=fr&appid=${owmKey}`);
        const forecastRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&units=metric&lang=fr&appid=${owmKey}`);
        const current = await currentRes.json();
        const forecast = await forecastRes.json();
        cacheData(cacheKey, { type: "openweathermap", current, forecast });
        applyWeatherData({ type: "openweathermap", current, forecast });
      }
    }

    function applyWeatherData(payload) {
      if (payload.type === "weatherapi") {
        const data = payload.data;
        const current = data.current;
        const forecast = data.forecast.forecastday;

        document.getElementById("current").innerHTML = `
          <div>
            <h2>Actuellement à ${data.location.name}</h2>
            <p><strong>${current.temp_c.toFixed(1)}°C</strong></p>
            <p>${current.condition.text}</p>
            <p>Vent : ${(current.wind_kph).toFixed(1)} km/h (${windDirection(current.wind_degree)})</p>
            <img src="https:${current.condition.icon}" alt="">
          </div>
        `;

        const forecastContainer = document.getElementById("forecast");
        forecastContainer.innerHTML = "";

        forecast.forEach(day => {
          const date = new Date(day.date);
          const weekday = date.toLocaleDateString("fr-FR", { weekday: "long" });
          forecastContainer.innerHTML += `
            <div class="day">
              <h3>${weekday}</h3>
              <img src="https:${day.day.condition.icon}" alt="">
              <p>${day.day.avgtemp_c.toFixed(1)}°C</p>
              <p>${day.day.condition.text}</p>
              <p>Vent : ${(day.day.maxwind_kph).toFixed(1)} km/h</p>
            </div>
          `;
        });

        const hourlyContainer = document.getElementById("hourly");
        hourlyContainer.innerHTML = "";
        const hours = forecast[0].hour.slice(0, 6);
        hours.forEach(hour => {
          const hourTime = new Date(hour.time).toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
          hourlyContainer.innerHTML += `
            <div class="hour">
              <h3>${hourTime}</h3>
              <img src="https:${hour.condition.icon}" alt="">
              <p>${hour.temp_c.toFixed(1)}°C</p>
              <p>${hour.condition.text}</p>
              <p>Vent : ${(hour.wind_kph).toFixed(1)} km/h (${windDirection(hour.wind_degree)})</p>
            </div>
          `;
        });

        const labels = hours.map(h => new Date(h.time).toLocaleTimeString("fr-FR", { hour: "2-digit" }));
        const temps = hours.map(h => h.temp_c);
        const ctx = document.getElementById("tempChart").getContext("2d");
        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Température (°C)",
              data: temps,
              borderColor: "#fff",
              backgroundColor: "rgba(255,255,255,0.3)",
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: "#fff" } }
            },
            scales: {
              x: { ticks: { color: "#fff" } },
              y: { ticks: { color: "#fff" } }
            }
          }
        });

        updateBackground(current.condition.text.toLowerCase());
        setWeatherAnimation(current.condition.text.toLowerCase());
      }

      if (payload.type === "openweathermap") {
        const current = payload.current;
        const forecast = payload.forecast;

        displayCurrent(current);
        displayForecast(forecast.list);
        displayHourly(forecast.list);
        drawChart(forecast.list);

        updateBackground(current.weather[0].main.toLowerCase());
        setWeatherAnimation(current.weather[0].main.toLowerCase());
      }
    }
  </script>
</body>
</html>
